general:
  branches:
    ignore:
      - develop

machine:
  environment:
    YARN_VERSION: 0.18.1
    PATH: "${PATH}:${HOME}/.yarn/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
  services:
    - docker
    - redis

dependencies:
  pre:
    - |
      if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
        echo "Download and install Yarn."
        curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
      else
        echo "The correct version of Yarn is already installed."
      fi
  cache_directories:
    - ~/.yarn
    - ~/.cache/yarn
  override:
    - yarn install
    - yarn global add pm2
    - yarn run build
    - docker build --rm=false -t jamout/api .

# @TODO also test the container itself
# It's difficult to test the actual container because of env vars
# For now, we'll test the app locally
test:
  override:
    - NODE_ENV=production pm2 start ./build/index.js
    - curl --retry 10 --retry-delay 5 -v http://localhost:3000/check

# we will always overwrite the production tag with the latest image build
# it saves space in the registry and costs less
# if we need to roll back we do so on github, github will trigger a rebuild and redeploy
# in the future we can tag hashes and clean up old images...
deployment:
  production:
    tag: /release-.*/
    commands:
      - chmod +x ./ecr-push
      - chmod +x ./ecs-deploy
      - ./ecr-push
      - ./ecs-deploy -c production -n api -i jamout/api:latest
